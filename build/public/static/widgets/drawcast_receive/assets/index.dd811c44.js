import{d as c,c as h,n as u,a as d,o as f,b as m}from"./vendor.11985ee1.js";const p=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}};p();const g=1001,r=4e3;class y{constructor(e,t){this.handle=null,this.reconnectTimeout=null,this.sendBuffer=[],this.onopen=()=>{},this.onclose=()=>{},this.onmessage=()=>{},this.addr=e,this.protocols=t}send(e){this.handle?this.handle.send(e):this.sendBuffer.push(e)}connect(){let e=new WebSocket(this.addr,this.protocols);e.onopen=t=>{for(this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.handle=e;this.sendBuffer.length>0;){const n=this.sendBuffer.shift();n&&this.handle.send(n)}this.onopen(t)},e.onmessage=t=>{this.onmessage(t)},e.onclose=t=>{this.handle=null,t.code===r||t.code===g||(this.reconnectTimeout=setTimeout(()=>{this.connect()},1e3)),this.onclose(t)}}disconnect(){this.handle&&this.handle.close(r)}}const w=(...s)=>console.log("[WsClient.ts]",...s);class v extends y{constructor(e,t){super(e,t);this._on={},this.onopen=n=>{this._dispatch("socket","open",n)},this.onmessage=n=>{if(this._dispatch("socket","message",n),this._on.message){const i=this._parseMessageData(n.data);i.event&&this._dispatch("message",i.event,i.data)}},this.onclose=n=>{this._dispatch("socket","close",n)}}onSocket(e,t){this.addEventListener("socket",e,t)}onMessage(e,t){this.addEventListener("message",e,t)}addEventListener(e,t,n){const i=Array.isArray(t)?t:[t];this._on[e]=this._on[e]||{};for(const o of i)this._on[e][o]=this._on[e][o]||[],this._on[e][o].push(n)}_parseMessageData(e){try{const t=JSON.parse(e);if(t.event)return{event:t.event,data:t.data||null}}catch{}return{event:null,data:null}}_dispatch(e,t,...n){const o=(this._on[e]||{})[t]||[];if(o.length!==0){w(`ws dispatch ${e} ${t}`);for(const a of o)a(...n)}}}const l=(s,e)=>`${window[s]!==`{{${s}}}`?window[s]:e}`,_=l("wsUrl",""),k=l("widgetToken","");var S={wsClient:s=>new v(_+"/"+s,k)},L=(s,e)=>{const t=s.__vccOpts||s;for(const[n,i]of e)t[n]=i;return t};const A=c({data(){return{ws:null,queue:[],worker:null,imgstyle:"",displayDuration:5e3,displayLatestForever:!1,notificationSound:null,notificationSoundAudio:null,latestResolved:!0,images:[]}},methods:{async playone({media:s,playsound:e}){return new Promise(async t=>{this.latestResolved=!1,await this.prepareImage(s.image.url),this.imgstyle={backgroundImage:`url(${s.image.url})`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",height:"100%"},e&&this.notificationSoundAudio&&this.notificationSoundAudio.play(),setTimeout(()=>{this.displayLatestForever||(this.imgstyle=""),this.latestResolved=!0,t()},this.displayDuration)})},addQueue(s,e){if(this.queue.push({media:s,playsound:e}),this.worker)return;const t=async()=>{if(this.queue.length===0){clearInterval(this.worker),this.worker=null;return}await this.playone(this.queue.shift()),this.worker=setTimeout(t,500)};this.worker=setTimeout(t,500)},async prepareImage(s){return new Promise(e=>{const t=new Image;t.src=s,this.$nextTick(()=>{t.loaded?e():t.onload=e})})},playmedia(s,e){this.addQueue(s,e)}},mounted(){this.ws=S.wsClient("drawcast"),this.ws.onMessage("init",s=>{this.displayDuration=s.settings.displayDuration,this.displayLatestForever=s.settings.displayLatestForever,this.notificationSound=s.settings.notificationSound,this.displayLatestAutomatically=s.settings.displayLatestAutomatically,!this.displayLatestForever&&this.latestResolved&&(this.imgstyle=""),this.notificationSound&&(this.notificationSoundAudio=new Audio(`/uploads/${encodeURIComponent(this.notificationSound.file)}`),this.notificationSoundAudio.volume=this.notificationSound.volume/100),this.images=s.images,this.displayLatestAutomatically&&this.images.length>0&&this.playmedia({image:{url:this.images[0]}},!1)}),this.ws.onMessage("post",s=>{this.images.unshift(s.img),this.images=this.images.slice(0,20),this.playmedia({image:{url:s.img}},!0)}),this.ws.connect()}});function T(s,e,t,n,i,o){return s.imgstyle?(f(),h("div",{key:0,style:u(s.imgstyle)},null,4)):d("",!0)}var C=L(A,[["render",T]]);const b=m(C);b.mount("#app");
