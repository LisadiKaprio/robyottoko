import{d as v,c as h,n as g,o as r,r as C,a,F as d,b as f,e as M,f as $,t as p,g as D}from"./vendor.77b9bbbd.js";const T=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function s(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=s(i);fetch(i.href,o)}};T();var k=(t,e)=>{const s=t.__vccOpts||t;for(const[n,i]of e)s[n]=i;return s};const N=v({props:{frames:{type:Array,required:!0},width:{type:Number,required:!1,default:64},height:{type:Number,required:!1,default:64}},data(){return{timeout:null,idx:-1}},watch:{frames:{handler(t,e){this.nextFrame()},deep:!0}},computed:{src(){return this.idx>=0&&this.idx<this.frames.length?this.frames[this.idx].url:""}},methods:{nextFrame(){if(this.frames.length===0){this.idx=-1;return}this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.idx++,this.idx>=this.frames.length&&(this.idx=0),this.timeout=setTimeout(()=>{this.nextFrame()},this.frames[this.idx].duration)}},created(){this.nextFrame()},unmounted(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}}),O=["src","width","height"];function A(t,e,s,n,i,o){return r(),h("span",{class:"avatar-animation",style:g({width:`${t.width}px`,height:`${t.width}px`})},[t.src?(r(),h("img",{key:0,src:t.src,width:t.width,height:t.height},null,8,O)):(r(),h("span",{key:1,style:g({width:`${t.width}px`,height:`${t.width}px`,display:"inline-block"})},null,4))],4)}var E=k(N,[["render",A]]);function w(t){this.context=t,this.instant=0,this.slow=0,this.clip=0,this.script=t.createScriptProcessor(2048,1,1);const e=this;this.script.onaudioprocess=function(s){const n=s.inputBuffer.getChannelData(0);let i,o=0,u=0;for(i=0;i<n.length;++i)o+=n[i]*n[i],Math.abs(n[i])>.99&&(u+=1);e.instant=Math.sqrt(o/n.length),e.slow=.95*e.slow+.05*e.instant,e.clip=u/n.length}}w.prototype.connectToSource=function(t,e){console.log("SoundMeter connecting");try{this.mic=this.context.createMediaStreamSource(t),this.mic.connect(this.script),this.script.connect(this.context.destination),typeof e!="undefined"&&e(null)}catch(s){console.error(s),typeof e!="undefined"&&e(s)}};w.prototype.stop=function(){console.log("SoundMeter stopping"),this.mic.disconnect(),this.script.disconnect()};const U=1001,y=4e3;class F{constructor(e,s){this.handle=null,this.reconnectTimeout=null,this.sendBuffer=[],this.onopen=()=>{},this.onclose=()=>{},this.onmessage=()=>{},this.addr=e,this.protocols=s}send(e){this.handle?this.handle.send(e):this.sendBuffer.push(e)}connect(){let e=new WebSocket(this.addr,this.protocols);e.onopen=s=>{for(this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.handle=e;this.sendBuffer.length>0;){const n=this.sendBuffer.shift();n&&this.handle.send(n)}this.onopen(s)},e.onmessage=s=>{this.onmessage(s)},e.onclose=s=>{this.handle=null,s.code===y||s.code===U||(this.reconnectTimeout=setTimeout(()=>{this.connect()},1e3)),this.onclose(s)}}disconnect(){this.handle&&this.handle.close(y)}}const L=(...t)=>console.log("[WsClient.ts]",...t);class B extends F{constructor(e,s){super(e,s);this._on={},this.onopen=n=>{this._dispatch("socket","open",n)},this.onmessage=n=>{if(this._dispatch("socket","message",n),this._on.message){const i=this._parseMessageData(n.data);i.event&&this._dispatch("message",i.event,i.data)}},this.onclose=n=>{this._dispatch("socket","close",n)}}onSocket(e,s){this.addEventListener("socket",e,s)}onMessage(e,s){this.addEventListener("message",e,s)}addEventListener(e,s,n){const i=Array.isArray(s)?s:[s];this._on[e]=this._on[e]||{};for(const o of i)this._on[e][o]=this._on[e][o]||[],this._on[e][o].push(n)}_parseMessageData(e){try{const s=JSON.parse(e);if(s.event)return{event:s.event,data:s.data||null}}catch{}return{event:null,data:null}}_dispatch(e,s,...n){const o=(this._on[e]||{})[s]||[];if(o.length!==0){L(`ws dispatch ${e} ${s}`);for(const u of o)u(...n)}}}const S=(t,e)=>`${window[t]!==`{{${t}}}`?window[t]:e}`,I=S("wsUrl",""),x=S("widgetToken","");var z={wsClient:t=>new B(I+"/"+t,x)};const _=.05,G=v({components:{AvatarAnimation:E},data(){return{ws:null,speaking:!1,lockedState:"default",initialized:!1,audioInitialized:!1,tuber:{slot:{}},tuberDef:null,settings:null}},computed:{animationName(){return this.lockedState!=="default"?this.lockedState:this.speaking?"speaking":"default"},animations(){return this.tuberDef.slotDefinitions.map(t=>{const e=t.items[this.tuber.slot[t.slot]],s=e.states.find(({state:n})=>n===this.animationName);return s.frames.length>0?s:e.states.find(({state:n})=>n==="default")})}},methods:{ctrl(t,e){this.ws.send(JSON.stringify({event:"ctrl",data:{ctrl:t,args:e}}))},setSlot(t,e){this.tuber.slot[t]=e,this.tuber.slot=Object.assign({},this.tuber.slot),this.ctrl("setSlot",[t,e])},setSpeaking(t){this.speaking!==t&&(this.speaking=t,this.ctrl("setSpeaking",[t]))},lockState(t){this.lockedState!==t&&(this.lockedState=t,this.ctrl("lockState",[t]))},setTuber(t){this.tuber.slot={},this.tuberDef=JSON.parse(JSON.stringify(t)),this.tuberDef.slotDefinitions.forEach(e=>{this.tuber.slot[e.slot]=e.defaultItemIndex}),this.ctrl("setTuber",[t])},startMic(){if(this.audioInitialized)return;if(this.audioInitialized=!0,navigator.getUserMedia||(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),!navigator.getUserMedia){alert("getUserMedia not supported in this browser.");return}const t=window.AudioContext||window.webkitAudioContext,e=new t;navigator.mediaDevices.getUserMedia({audio:!0}).then(s=>{const n=new w(e);n.connectToSource(s,i=>{if(i){console.log(i);return}setInterval(()=>{const o=this.speaking?_/2:_;this.setSpeaking(n.instant.toFixed(2)>o)},100)})}).catch(s=>{console.log(s),alert("Error capturing audio.")})},applyStyles(){const t=this.settings.styles;t.bgColor!=null&&(document.bgColor=t.bgColor)}},mounted(){this.ws=z.wsClient("avatar"),this.ws.onMessage("init",t=>{this.settings=t.settings,this.$nextTick(()=>{this.applyStyles()}),this.setTuber(this.settings.avatarDefinitions[0]),this.initialized=!0}),this.ws.connect()}}),W={key:0,class:"base"},q=a("td",null,"Start Mic",-1),P=["onClick"],J=a("td",null,"State:",-1),j=["onClick"],H=a("td",null,"Tubers:",-1),K=["onClick"];function V(t,e,s,n,i,o){const u=C("avatar-animation");return t.initialized?(r(),h("div",W,[a("div",{class:"avatar",style:g({width:`${t.tuberDef.width}px`,height:`${t.tuberDef.height}px`})},[(r(!0),h(d,null,f(t.animations,(l,c)=>(r(),$(u,{key:c,frames:l.frames,width:t.tuberDef.width,height:t.tuberDef.height},null,8,["frames","width","height"]))),128))],4),a("table",null,[a("tr",null,[q,a("td",null,[a("button",{onClick:e[0]||(e[0]=(...l)=>t.startMic&&t.startMic(...l))},"Start")])]),(r(!0),h(d,null,f(t.tuberDef.slotDefinitions,(l,c)=>(r(),h("tr",{key:c},[a("td",null,p(l.slot)+":",1),a("td",null,[(r(!0),h(d,null,f(l.items,(m,b)=>(r(),h("button",{onClick:Q=>t.setSlot(l.slot,b),key:b},p(m.title),9,P))),128))])]))),128)),a("tr",null,[J,a("td",null,[(r(!0),h(d,null,f(t.tuberDef.stateDefinitions,(l,c)=>(r(),h("button",{key:c,onClick:m=>t.lockState(l.value)},p(l.value),9,j))),128))])]),a("tr",null,[H,a("td",null,[(r(!0),h(d,null,f(t.settings.avatarDefinitions,(l,c)=>(r(),h("button",{onClick:m=>t.setTuber(l),key:c},p(l.name),9,K))),128))])])])])):M("",!0)}var R=k(G,[["render",V]]);const Y=D(R);Y.mount("#app");
