import{d as h,c as l,n as p,o as a,r as g,a as _,F as k,b,e as v,f as w,g as y}from"./vendor.7b9d16b9.js";const S=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function s(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=s(i);fetch(i.href,o)}};S();var c=(e,t)=>{const s=e.__vccOpts||e;for(const[n,i]of t)s[n]=i;return s};const $=h({props:{frames:{type:Array,required:!0},width:{type:Number,required:!1,default:64},height:{type:Number,required:!1,default:64}},data(){return{timeout:null,idx:-1}},watch:{frames:{handler(e,t){this.nextFrame()},deep:!0}},computed:{src(){return this.idx>=0&&this.idx<this.frames.length?this.frames[this.idx].url:""}},methods:{nextFrame(){if(this.frames.length===0){this.idx=-1;return}this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.idx++,this.idx>=this.frames.length&&(this.idx=0),this.timeout=setTimeout(()=>{this.nextFrame()},this.frames[this.idx].duration)}},created(){this.nextFrame()},unmounted(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}}),T={class:"avatar-animation"},N=["src","width","height"];function C(e,t,s,n,i,o){return a(),l("span",T,[e.src?(a(),l("img",{key:0,src:e.src,width:e.width,height:e.height},null,8,N)):(a(),l("span",{key:1,style:p({width:`${e.width}px`,height:`${e.width}px`,display:"inline-block"})},null,4))])}var x=c($,[["render",C]]);const O=1001,u=4e3;class D{constructor(t,s){this.handle=null,this.reconnectTimeout=null,this.sendBuffer=[],this.onopen=()=>{},this.onclose=()=>{},this.onmessage=()=>{},this.addr=t,this.protocols=s}send(t){this.handle?this.handle.send(t):this.sendBuffer.push(t)}connect(){let t=new WebSocket(this.addr,this.protocols);t.onopen=s=>{for(this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.handle=t;this.sendBuffer.length>0;){const n=this.sendBuffer.shift();n&&this.handle.send(n)}this.onopen(s)},t.onmessage=s=>{this.onmessage(s)},t.onclose=s=>{this.handle=null,s.code===u||s.code===O||(this.reconnectTimeout=setTimeout(()=>{this.connect()},1e3)),this.onclose(s)}}disconnect(){this.handle&&this.handle.close(u)}}const A=(...e)=>console.log("[WsClient.ts]",...e);class E extends D{constructor(t,s){super(t,s);this._on={},this.onopen=n=>{this._dispatch("socket","open",n)},this.onmessage=n=>{if(this._dispatch("socket","message",n),this._on.message){const i=this._parseMessageData(n.data);i.event&&this._dispatch("message",i.event,i.data)}},this.onclose=n=>{this._dispatch("socket","close",n)}}onSocket(t,s){this.addEventListener("socket",t,s)}onMessage(t,s){this.addEventListener("message",t,s)}addEventListener(t,s,n){const i=Array.isArray(s)?s:[s];this._on[t]=this._on[t]||{};for(const o of i)this._on[t][o]=this._on[t][o]||[],this._on[t][o].push(n)}_parseMessageData(t){try{const s=JSON.parse(t);if(s.event)return{event:s.event,data:s.data||null}}catch{}return{event:null,data:null}}_dispatch(t,s,...n){const o=(this._on[t]||{})[s]||[];if(o.length!==0){A(`ws dispatch ${t} ${s}`);for(const r of o)r(...n)}}}const d=(e,t)=>`${window[e]!==`{{${e}}}`?window[e]:t}`,F=d("wsUrl",""),L=d("widgetToken","");var B={wsClient:e=>new E(F+"/"+e,L)};const M=h({components:{AvatarAnimation:x},data(){return{speaking:!1,lockedState:"default",initialized:!1,tuber:{slot:{}},tuberDef:null,settings:null}},computed:{animationName(){return this.lockedState!=="default"?this.lockedState:this.speaking?"speaking":"default"},animations(){return this.tuberDef.slotDefinitions.map(e=>{const t=e.items[this.tuber.slot[e.slot]],s=t.states.find(({state:n})=>n===this.animationName);return s.frames.length>0?s:t.states.find(({state:n})=>n==="default")})}},methods:{setSlot(e,t){this.tuber.slot[e]=t,this.tuber.slot=Object.assign({},this.tuber.slot)},setSpeaking(e){this.speaking!==e&&(this.speaking=e)},lockState(e){this.lockedState!==e&&(this.lockedState=e)},setTuber(e){this.tuber.slot={},this.tuberDef=JSON.parse(JSON.stringify(e)),this.tuberDef.slotDefinitions.forEach(t=>{this.tuber.slot[t.slot]=t.defaultItemIndex})},applyStyles(){const e=this.settings.styles;e.bgColor!=null&&(document.bgColor=e.bgColor)}},mounted(){this.ws=B.wsClient("avatar"),this.ws.onMessage("init",e=>{this.settings=e.settings,this.$nextTick(()=>{this.applyStyles()}),this.setTuber(this.settings.avatarDefinitions[0]),this.initialized=!0}),this.ws.onMessage("ctrl",({data:e})=>{if(e.ctrl==="setSlot"){const t=e.args[0],s=e.args[1];this.setSlot(t,s)}else if(e.ctrl==="setSpeaking"){const t=e.args[0];this.setSpeaking(t)}else if(e.ctrl==="lockState"){const t=e.args[0];this.lockState(t)}else if(e.ctrl==="setTuber"){const t=e.args[0];this.setTuber(t)}}),this.ws.connect()}}),I={key:0,class:"base"},W={class:"avatar"};function q(e,t,s,n,i,o){const r=g("avatar-animation");return e.initialized?(a(),l("div",I,[_("div",W,[(a(!0),l(k,null,b(e.animations,(f,m)=>(a(),w(r,{key:m,frames:f.frames,width:256,height:256},null,8,["frames"]))),128))])])):v("",!0)}var z=c(M,[["render",q]]);const J=y(z);J.mount("#app");
