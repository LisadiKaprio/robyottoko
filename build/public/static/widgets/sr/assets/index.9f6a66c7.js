import{d as p,r as m,o as l,c as r,a,b as _,e as f,n as w,f as k,F as V,g as M,h as b,t as h,i as g,j as E}from"./vendor.42bf0c53.js";const B=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function s(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=s(i);fetch(i.href,o)}};B();const O=1001,P=4e3;class L{constructor(e,s){this.handle=null,this.reconnectTimeout=null,this.sendBuffer=[],this.onopen=()=>{},this.onclose=()=>{},this.onmessage=()=>{},this.addr=e,this.protocols=s}send(e){this.handle?this.handle.send(e):this.sendBuffer.push(e)}connect(){let e=new WebSocket(this.addr,this.protocols);e.onopen=s=>{for(this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.handle=e;this.sendBuffer.length>0;){const n=this.sendBuffer.shift();n&&this.handle.send(n)}this.onopen(s)},e.onmessage=s=>{this.onmessage(s)},e.onclose=s=>{this.handle=null,s.code===P||s.code===O||(this.reconnectTimeout=setTimeout(()=>{this.connect()},1e3)),this.onclose(s)}}disconnect(){this.handle&&this.handle.close(P)}}const D=(...t)=>console.log("[WsClient.ts]",...t);class A extends L{constructor(e,s){super(e,s);this._on={},this.onopen=n=>{this._dispatch("socket","open",n)},this.onmessage=n=>{if(this._dispatch("socket","message",n),this._on.message){const i=this._parseMessageData(n.data);i.event&&this._dispatch("message",i.event,i.data)}},this.onclose=n=>{this._dispatch("socket","close",n)}}onSocket(e,s){this.addEventListener("socket",e,s)}onMessage(e,s){this.addEventListener("message",e,s)}addEventListener(e,s,n){const i=Array.isArray(s)?s:[s];this._on[e]=this._on[e]||{};for(const o of i)this._on[e][o]=this._on[e][o]||[],this._on[e][o].push(n)}_parseMessageData(e){try{const s=JSON.parse(e);if(s.event)return{event:s.event,data:s.data||null}}catch{}return{event:null,data:null}}_dispatch(e,s,...n){const o=(this._on[e]||{})[s]||[];if(o.length!==0){D(`ws dispatch ${e} ${s}`);for(const d of o)d(...n)}}}const I=(t,e)=>`${window[t]!==`{{${t}}}`?window[t]:e}`,N=I("wsUrl",""),R=I("widgetToken","");var j={wsClient:t=>new A(N+"/"+t,R)},c=(t,e)=>{const s=t.__vccOpts||t;for(const[n,i]of e)s[n]=i;return s};const Y=p({data(){return{ws:null,filter:{tag:""},hasPlayed:!1,playlist:[],settings:{volume:100,hideVideoImage:{file:"",filename:""},customCss:"",customCssPresets:[],showProgressBar:!1,initAutoplay:!0,showThumbnails:!0,maxItemsShown:-1},progress:0,progressInterval:null,inited:!1}},watch:{playlist:function(t,e){t.find((s,n)=>!this.isFilteredOut(s,n))||this.player.stop()},filter:function(t,e){this.playlist.find((s,n)=>!this.isFilteredOut(s,n))||this.player.stop()}},computed:{classes(){return[this.settings.showThumbnails?"with-thumbnails":"without-thumbnails",this.settings.showProgressBar?"with-progress-bar":"without-progress-bar"]},player(){return this.$refs.youtube},progressValueStyle(){return{width:`${this.progress*100}%`}},playlistItems(){const t=[];for(const e in this.playlist){const s=this.playlist[e];this.isFilteredOut(s,e)||(t[e]=s)}return t},filteredPlaylist(){return this.filter.tag===""?this.playlist:this.playlist.filter(t=>t.tags.includes(this.filter.tag))},hidevideo(){return this.item?this.item.hidevideo:!1},item(){return this.filteredPlaylist[0]},hasItems(){return this.filteredPlaylist.length!==0}},methods:{isFilteredOut(t,e){return this.settings.maxItemsShown>=0&&this.settings.maxItemsShown-1<e?!0:this.filter.tag!==""&&!t.tags.includes(this.filter.tag)},ended(){this.sendMsg({event:"ended"})},sendMsg(t){this.ws.send(JSON.stringify(t))},play(){this.hasPlayed=!0,this.adjustVolume(),this.hasItems&&(this.player.play(this.item.yt),this.sendMsg({event:"play",id:this.item.id}))},unpause(){this.hasItems&&(this.player.unpause(),this.sendMsg({event:"unpause",id:this.item.id}))},pause(){this.hasItems&&(this.player.pause(),this.sendMsg({event:"pause"}))},adjustVolume(){this.player&&this.player.setVolume(this.settings.volume)},applySettings(t){if(this.settings.customCss!==t.customCss){let e=document.getElementById("customCss");e&&e.parentElement.removeChild(e),e=document.createElement("style"),e.id="customCss",e.textContent=t.customCss,document.head.appendChild(e)}this.settings.showProgressBar!==t.showProgressBar&&(this.progressInterval&&window.clearInterval(this.progressInterval),t.showProgressBar&&(this.progressInterval=window.setInterval(()=>{this.player&&(this.progress=this.player.getProgress())},500))),this.settings=t,this.adjustVolume()}},mounted(){this.ws=j.wsClient("sr"),this.ws.onMessage(["save","settings"],t=>{this.applySettings(t.settings)}),this.ws.onMessage(["onEnded","prev","skip","remove","clear","move","tags"],t=>{this.applySettings(t.settings);const e=this.filteredPlaylist.length>0?this.filteredPlaylist[0].id:null;this.filter=t.filter,this.playlist=t.playlist;const s=this.filteredPlaylist.length>0?this.filteredPlaylist[0].id:null;e!==s&&this.play()}),this.ws.onMessage(["filter"],t=>{this.applySettings(t.settings);const e=this.filteredPlaylist.length>0?this.filteredPlaylist[0].id:null;this.filter=t.filter,this.playlist=t.playlist,this.filteredPlaylist.find(s=>s.id===e)||this.play()}),this.ws.onMessage(["pause"],t=>{this.player.playing()&&this.pause()}),this.ws.onMessage(["unpause"],t=>{this.player.playing()||(this.hasPlayed?this.unpause():this.play())}),this.ws.onMessage(["loop"],t=>{this.player.setLoop(!0)}),this.ws.onMessage(["noloop"],t=>{this.player.setLoop(!1)}),this.ws.onMessage(["dislike","like","video","playIdx","resetStats","shuffle"],t=>{this.applySettings(t.settings),this.filter=t.filter,this.playlist=t.playlist}),this.ws.onMessage(["add","init"],t=>{this.applySettings(t.settings),this.filter=t.filter,this.playlist=t.playlist,!this.inited&&!this.player.playing()&&this.settings.initAutoplay&&this.play(),this.inited=!0}),this.ws.connect()}}),F={class:"player video-16-9"},W={key:1,class:"hide-video"},q={key:2,class:"progress"},U={class:"list"};function z(t,e,s,n,i,o){const d=m("responsive-image"),S=m("youtube"),C=m("list-item");return l(),r("div",{class:b(["wrapper",t.classes])},[a("div",F,[t.hidevideo&&t.settings.hideVideoImage.file?(l(),_(d,{key:0,class:"hide-video",src:t.settings.hideVideoImage.file},null,8,["src"])):t.hidevideo?(l(),r("div",W)):f("",!0),t.settings.showProgressBar?(l(),r("div",q,[a("div",{class:"progress-value",style:w(t.progressValueStyle)},null,4)])):f("",!0),k(S,{ref:"youtube",onEnded:t.ended},null,8,["onEnded"])]),a("ol",U,[(l(!0),r(V,null,M(t.playlistItems,(T,v)=>(l(),_(C,{class:b(v===0?"playing":"not-playing"),key:v,item:T,showThumbnails:t.settings.showThumbnails},null,8,["class","item","showThumbnails"]))),128))])],2)}var G=c(Y,[["render",z]]);const J=p({name:"responsive-image",props:{src:String,title:String,height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url(/uploads/${encodeURIComponent(this.src)})`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}}),K=["title"];function H(t,e,s,n,i,o){return l(),r("div",{class:"responsive-image",style:w(t.style),title:t.title},null,12,K)}var Q=c(J,[["render",H]]);const u=(...t)=>console.log("[youtube.js]",...t);let $=!1;function X(){return $?(u("ytapi ALREADY ready"),Promise.resolve()):new Promise(t=>{const e=document.createElement("script");e.src="https://www.youtube.com/iframe_api",document.head.append(e),window.onYouTubeIframeAPIReady=()=>{$=!0,u("ytapi ready"),t()}})}function Z(t){return new Promise(e=>{u("create player on "+t);const s=new YT.Player(t,{playerVars:{iv_load_policy:3,modestbranding:1},events:{onReady:()=>{u("player ready"),e(s)}}})})}async function x(t){return await X(),await Z(t)}const tt=p({name:"youtube",props:{visible:{type:Boolean,default:!0}},data:()=>({id:"",yt:null,toplay:null,tovolume:null,tryPlayInterval:null}),created(){this.id=`yt-${Math.floor(Math.random()*99+1)}-${new Date().getTime()}`},methods:{getDuration(){return this.yt?this.yt.getDuration():0},getCurrentTime(){return this.yt?this.yt.getCurrentTime():0},getProgress(){const t=this.getDuration(),e=this.getCurrentTime();return t?e/t:0},stop(){this.yt&&this.yt.stopVideo()},stopTryPlayInterval(){this.tryPlayInterval&&(clearInterval(this.tryPlayInterval),this.tryPlayInterval=null)},tryPlay(){if(this.stopTryPlayInterval(),!this.visible)return;this.yt.playVideo();let t=20;this.tryPlayInterval=setInterval(()=>{if(u("playing",this.playing(),"triesRemaining",t),--t,this.playing()||t<0){u("stopping interval"),this.stopTryPlayInterval();return}this.yt.playVideo()},250)},play(t){this.yt?(this.yt.cueVideoById(t),this.tryPlay()):this.toplay=t},pause(){this.yt&&this.yt.pauseVideo()},unpause(){this.yt&&this.tryPlay()},setVolume(t){this.yt?this.yt.setVolume(t):this.tovolume=t},setLoop(t){this.loop=t},playing(){return this.yt&&this.yt.getPlayerState()===1}},async mounted(){this.yt=await x(this.id),this.tovolume!==null&&this.yt.setVolume(this.tovolume),this.toplay!==null&&(u("trying to play.."),this.play(this.toplay)),this.yt.addEventListener("onStateChange",t=>{t.data===YT.PlayerState.CUED?this.tryPlay():t.data===YT.PlayerState.ENDED&&(this.loop?this.tryPlay():this.$emit("ended"))})}}),et=["id"];function st(t,e,s,n,i,o){return l(),r("div",{id:t.id},null,8,et)}var it=c(tt,[["render",st]]);const nt=p({props:{item:{type:Object,required:!0},showThumbnails:{type:Boolean,required:!0}},template:" ",computed:{thumbnail(){return`https://i.ytimg.com/vi/${this.item.yt}/mqdefault.jpg`}}}),at=["data-user","data-yt"],ot={key:0,class:"thumbnail"},lt={class:"media-16-9"},rt=["src"],ht={class:"title"},dt={class:"title-content title-orig"},ut={class:"title-content title-dupl"},pt={class:"meta meta-left"},ct={class:"meta-user"},yt=a("span",{class:"meta-user-text-before"},"requested by ",-1),mt={class:"meta-user-name"},ft=a("span",{class:"meta-user-text-after"},null,-1),gt={class:"meta-plays"},vt=a("span",{class:"meta-plays-text-before"},"played ",-1),_t={class:"meta-plays-count"},wt={class:"meta-plays-text-after"},bt={class:"meta meta-right vote"},Pt={class:"meta-plays"},It=a("i",{class:"fa fa-repeat"},null,-1),$t={class:"vote-up"},St=a("i",{class:"fa fa-thumbs-up"},null,-1),Ct={class:"vote-down"},Tt=a("i",{class:"fa fa-thumbs-down"},null,-1);function kt(t,e,s,n,i,o){return l(),r("li",{class:"item","data-user":t.item.user,"data-yt":t.item.yt},[t.showThumbnails?(l(),r("div",ot,[a("div",lt,[a("img",{src:t.thumbnail},null,8,rt)])])):f("",!0),a("div",ht,[a("span",dt,h(t.item.title||t.item.yt),1),a("span",ut,h(t.item.title||t.item.yt),1)]),a("div",pt,[a("span",ct,[yt,a("span",mt,h(t.item.user),1),ft]),a("span",gt,[vt,a("span",_t,h(t.item.plays),1),a("span",wt," time"+h(t.item.plays===1?"":"s"),1)])]),a("div",bt,[a("span",Pt,[It,g(" "+h(t.item.plays),1)]),a("span",$t,[St,g(" "+h(t.item.goods),1)]),a("span",Ct,[Tt,g(" "+h(t.item.bads),1)])])],8,at)}var Vt=c(nt,[["render",kt]]);const y=E(G);y.component("responsive-image",Q);y.component("youtube",it);y.component("list-item",Vt);y.mount("#app");
